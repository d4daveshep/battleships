{% extends "base.html" %}

{% block title %}Gameplay - Battleships{% endblock %}

{% block content %}
<h1 data-testid="round-indicator">Round {{ round_number }}</h1>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Game Information</h2>
    </div>
    <div class="card-body">
        <p class="game-info-item"><strong>Player:</strong> {{ player_name }}</p>
        <p class="game-info-item"><strong>Opponent:</strong> {{ opponent_name }}</p>
        <p class="game-info-item"><strong>Game ID:</strong> {{ game_id }}</p>
        <div class="game-stats mt-3">
            <p class="game-stat-item" data-testid="ships-sunk"><strong>Ships Sunk:</strong> {{ ships_sunk_count }}/5</p>
            <p class="game-stat-item" data-testid="ships-lost"><strong>Ships Lost:</strong> {{ ships_lost_count }}/5</p>
        </div>
    </div>
</div>

{% if status_message %}
<div class="alert alert-info" data-testid="game-status">
    {{ status_message }}
</div>
{% endif %}

{# 
    Two-column board layout:
    - Left: Player's own ships and incoming shots
    - Right: Shots fired at opponent with integrated aiming interface
#}
<div class="grid grid-2">
    <!-- Player's Board (Own Ships) -->
    <div class="ship-board-container">
        <h3>My Ships</h3>
        <p>Your fleet and incoming shots</p>
        
        {# Build a lookup map of cell -> ship data for quick access #}
        {% set cell_to_ship = {} %}
        {% if player_board and player_board.ships %}
            {% for ship_name, ship_data in player_board.ships.items() %}
                {% for cell in ship_data.cells %}
                    {% set _ = cell_to_ship.update({cell: {"name": ship_name, "code": ship_data.code}}) %}
                {% endfor %}
            {% endfor %}
        {% endif %}
        
        {# Get shots_received dict (coord -> round_number) #}
        {% set shots_received = player_board.shots_received if player_board and player_board.shots_received else {} %}
        
        {# 10x10 Grid Visualization #}
        <table data-testid="player-board" class="ship-grid">
            <thead>
                <tr>
                    <th></th>
                    {% for col in range(1, 11) %}
                    <th>{{ col }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% set rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'] %}
                {% for row in rows %}
                <tr>
                    <th>{{ row }}</th>
                    {% for col in range(1, 11) %}
                        {% set coord = row ~ col %}
                        {% set ship_data = cell_to_ship.get(coord) %}
                        {% set is_hit = coord in shots_received %}
                        <td data-testid="player-cell-{{ coord }}" 
                            class="ship-grid-cell {% if is_hit %}cell--hit{% endif %}"
                            {% if ship_data %}data-ship="{{ ship_data.name.lower() }}"{% endif %}>
                            {% if is_hit %}
                                {# Show incoming shot marker with round number #}
                                <span class="incoming-shot" aria-label="Hit in round {{ shots_received[coord] }}">
                                    {% if ship_data %}{{ ship_data.code }}{% endif %}<sub>{{ shots_received[coord] }}</sub>
                                </span>
                            {% elif ship_data %}
                                {# Show ship code (A=Carrier, B=Battleship, C=Cruiser, S=Submarine, D=Destroyer) #}
                                {{ ship_data.code }}
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {# Ship Legend #}
        <div class="ship-legend">
            <strong>Ship Legend:</strong>
            <div class="legend-item">
                <span class="legend-color carrier"></span>
                <span>A = Carrier (5 cells)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color battleship"></span>
                <span>B = Battleship (4 cells)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color cruiser"></span>
                <span>C = Cruiser (3 cells)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color submarine"></span>
                <span>S = Submarine (3 cells)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color destroyer"></span>
                <span>D = Destroyer (2 cells)</span>
            </div>
        </div>
    </div>

    <!-- Shots Fired Board (Interactive Aiming) -->
    <div class="ship-board-container">
        <h3>Shots Fired</h3>
        <p>Aim and fire at {{ opponent_name }}</p>
        
        {# 
            Aiming Interface - Loaded via HTMX on page load
            Contains: shot counter, interactive grid, aimed shots list, fire button
        #}
        <div id="aiming-interface"
             hx-get="/game/{{ game_id }}/aiming-interface"
             hx-trigger="load"
             hx-swap="innerHTML">
            <div class="loading-message" data-testid="aiming-loading">
                Loading aiming interface...
            </div>
        </div>
    </div>
</div>

<!-- Hits Made Area -->
<div class="hits-made-area" data-testid="hits-made-area">
        <h3>Hits Made</h3>
        <div class="hits-made-grid">
            {% for ship_name, hits in hits_made_data.items() %}
            <div class="hits-made-row" data-testid="hits-made-row-{{ ship_name }}">
                <span class="ship-label">{{ ship_name }}: {{ hits|length }} hit{% if hits|length != 1 %}s{% endif %} total</span>
                <div class="hit-slots">
                    {% set ship_length = 0 %}
                    {% if ship_name == 'Carrier' %}{% set ship_length = 5 %}
                    {% elif ship_name == 'Battleship' %}{% set ship_length = 4 %}
                    {% elif ship_name == 'Cruiser' %}{% set ship_length = 3 %}
                    {% elif ship_name == 'Submarine' %}{% set ship_length = 3 %}
                    {% elif ship_name == 'Destroyer' %}{% set ship_length = 2 %}
                    {% endif %}
                    
                    {% for i in range(ship_length) %}
                    <div class="hit-slot {% if i < hits|length %}hit{% endif %}" data-testid="hit-slot-{{ ship_name }}-{{ i }}">
                        {% if i < hits|length %}
                            {{ hits[i] }}
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

<!-- Game Actions -->
<div class="game-actions">
        <h3>Other Actions</h3>
        <div class="btn-group">
            <button class="btn btn-warning" disabled>
                üè≥Ô∏è Surrender (Coming Soon)
            </button>
        </div>
    </div>

    <style>
        .hits-made-area {
            margin-top: 2rem;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .hits-made-grid {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .hits-made-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .ship-label {
            width: 250px;
            font-weight: bold;
        }
        .hit-slots {
            display: flex;
            gap: 0.25rem;
        }
        .hit-slot {
            width: 30px;
            height: 30px;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            font-size: 0.8rem;
        }
        .hit-slot.hit {
            background-color: #ffcccc;
            color: #cc0000;
            font-weight: bold;
        }
    </style>
{% endblock %}
