{% extends "base.html" %}

{% block title %}Gameplay - Battleships{% endblock %}

{% block content %}
<style>
    /* Styles for interactive grid */
    .interactive-cell label {
        display: block;
        width: 100%;
        height: 100%;
        cursor: pointer;
        position: relative;
    }
    .interactive-cell input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }
    .interactive-cell input[type="checkbox"]:checked ~ .cell-marker {
        background-color: rgba(255, 0, 0, 0.3);
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 2px solid var(--color-hit);
        box-shadow: inset 0 0 10px var(--color-hit);
    }
    .cell-marker {
        width: 100%;
        height: 100%;
        display: block;
    }
    .interactive-cell:hover {
        background-color: var(--color-grid-hover);
    }
    .aimed-cell .cell-marker {
        background-color: rgba(255, 0, 0, 0.3);
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 2px solid var(--color-hit);
        box-shadow: inset 0 0 10px var(--color-hit);
    }
</style>

<div id="gameplay-container">
    <h1 data-testid="round-indicator">Round {{ round_number }}</h1>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Game Information</h2>
        </div>
        <div class="card-body">
            <p class="game-info-item"><strong>Player:</strong> {{ player_name }}</p>
            <p class="game-info-item"><strong>Opponent:</strong> {{ opponent_name }}</p>
            <p class="game-info-item"><strong>Game ID:</strong> {{ game_id }}</p>
            <p class="game-info-item" data-testid="shots-available">Shots Available: {{ shots_available }}</p>
            <div id="aiming-status" data-testid="aiming-status">
                <p class="game-info-item" data-testid="shots-aimed-display">Shots Aimed: {{ aimed_count }}/{{ shots_available }}</p>
            </div>
        </div>
    </div>

    {% if status_message %}
    <div class="alert alert-info" data-testid="game-status">
        {{ status_message }}
    </div>
    {% endif %}

    <div class="grid grid-2">
        <!-- My Ships Board (Static) -->
        <div class="ship-board-container">
            <h3>My Ships and Shots Received</h3>
            <p>Your fleet and incoming shots</p>
            
            {# Build a lookup map of cell -> ship data for quick access #}
            {% set cell_to_ship = {} %}
            {% if player_board and player_board.ships %}
                {% for ship_name, ship_data in player_board.ships.items() %}
                    {% for cell in ship_data.cells %}
                        {% set _ = cell_to_ship.update({cell: {"name": ship_name, "code": ship_data.code}}) %}
                    {% endfor %}
                {% endfor %}
            {% endif %}
            
            <table data-testid="my-ships-board" class="ship-grid">
                <thead>
                    <tr>
                        <th></th>
                        {% for col in range(1, 11) %}
                        <th>{{ col }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% set rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'] %}
                    {% for row in rows %}
                    <tr>
                        <th>{{ row }}</th>
                        {% for col in range(1, 11) %}
                            {% set coord = row ~ col %}
                            {% set ship_data = cell_to_ship.get(coord) %}
                            <td data-testid="player-cell-{{ coord }}" 
                                class="ship-grid-cell"
                                {% if ship_data %}data-ship="{{ ship_data.name.lower() }}"{% endif %}>
                                {% if ship_data %}
                                    {{ ship_data.code }}
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Shots Fired Board (Interactive) -->
        <div class="ship-board-container">
            <h3>Shots Fired</h3>
            <p>Select targets and fire!</p>
            
            <table data-testid="shots-fired-board" class="ship-grid">
                <thead>
                    <tr>
                        <th></th>
                        {% for col in range(1, 11) %}
                        <th>{{ col }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% set rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'] %}
                    {% for row in rows %}
                    <tr>
                        <th>{{ row }}</th>
                        {% for col in range(1, 11) %}
                            {% set coord = row ~ col %}
                            {% set is_aimed = coord in aimed_coordinates %}
                            <td data-testid="opponent-cell-{{ coord }}" 
                                class="ship-grid-cell interactive-cell{% if is_aimed %} aimed-cell{% endif %}"
                                {% if is_aimed %}data-aimed="true"{% endif %}>
                                <label>
                                    <input type="checkbox" 
                                           name="coordinate" 
                                           value="{{ coord }}"
                                           {% if is_aimed %}checked{% endif %}
                                           hx-post="/aim-shot"
                                           hx-vals='{"game_id": "{{ game_id }}", "coordinate": "{{ coord }}"}'
                                           hx-target="#aiming-status"
                                           hx-swap="outerHTML">
                                    <span class="cell-marker"></span>
                                </label>
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <form method="POST" action="/fire-shots" hx-post="/fire-shots" hx-target="#gameplay-container" hx-select="#gameplay-container" hx-swap="outerHTML">
                <input type="hidden" name="game_id" value="{{ game_id }}">
                <input type="hidden" name="player_name" value="{{ player_name }}">
                <div style="margin-top: 20px; text-align: center;">
                    <button id="fire-shots-btn"
                            type="submit" 
                            class="btn-primary btn-large" 
                            data-testid="fire-shots-button"
                            {% if aimed_count == 0 %}disabled{% endif %}>
                        Fire Shots
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hits Made Area -->
    <div class="ship-board-container" data-testid="hits-made-area">
        <h3>Opponent Ships Status</h3>
        <div class="ship-legend">
            {% set ships = ["Carrier", "Battleship", "Cruiser", "Submarine", "Destroyer"] %}
            {% for ship in ships %}
            <div class="legend-item">
                <span class="legend-color {{ ship.lower() }}"></span>
                <span>{{ ship }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
