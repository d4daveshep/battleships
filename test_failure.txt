============================= test session starts ==============================
platform linux -- Python 3.13.3, pytest-8.4.2, pluggy-1.6.0 -- /home/david/dev/battleships/.venv/bin/python
cachedir: .pytest_cache
rootdir: /home/david/dev/battleships
configfile: pyproject.toml
plugins: anyio-4.10.0, xdist-3.8.0, bdd-8.1.0, cov-7.0.0, asyncio-1.1.0
asyncio: mode=Mode.STRICT, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/bdd/test_gameplay_steps_browser.py::test_long_polling_connection_resilience INFO:     127.0.0.1:34500 - "GET /health HTTP/1.1" 200 OK
INFO:     127.0.0.1:34510 - "POST /test/reset-lobby HTTP/1.1" 200 OK
INFO:     127.0.0.1:34514 - "GET /login HTTP/1.1" 200 OK
INFO:     127.0.0.1:34514 - "GET /static/css/main.css HTTP/1.1" 200 OK
INFO:     127.0.0.1:34514 - "POST /login HTTP/1.1" 204 No Content
INFO:     127.0.0.1:34514 - "GET /lobby HTTP/1.1" 200 OK
INFO:     127.0.0.1:34514 - "GET /lobby/status/long-poll HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "GET /login HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "GET /static/css/main.css HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "POST /login HTTP/1.1" 204 No Content
INFO:     127.0.0.1:34514 - "GET /lobby/status/long-poll?version=1 HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "GET /lobby HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "GET /lobby/status/long-poll HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "GET /lobby HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "GET /lobby/status/long-poll HTTP/1.1" 200 OK
INFO:     127.0.0.1:34550 - "POST /select-opponent HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "GET /lobby/status/long-poll?version=2 HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "GET /lobby/status/long-poll?version=2 HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "POST /accept-game-request HTTP/1.1" 204 No Content
INFO:     127.0.0.1:34524 - "GET /start-game HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "GET /lobby/status/long-poll?version=3 HTTP/1.1" 204 No Content
INFO:     127.0.0.1:34534 - "GET /start-game HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "POST /start-game HTTP/1.1" 303 See Other
INFO:     127.0.0.1:34534 - "GET /place-ships HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "GET /place-ships/opponent-status HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "POST /start-game HTTP/1.1" 303 See Other
INFO:     127.0.0.1:34524 - "GET /place-ships HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "GET /place-ships/opponent-status HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "POST /place-ship HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "GET /place-ships/opponent-status HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "POST /place-ship HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "GET /place-ships/opponent-status HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "POST /place-ship HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "GET /place-ships/opponent-status HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "POST /place-ship HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "GET /place-ships/opponent-status HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "POST /place-ship HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "GET /place-ships/opponent-status HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "POST /place-ship HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "GET /place-ships/opponent-status HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "POST /place-ship HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "GET /place-ships/opponent-status HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "POST /place-ship HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "GET /place-ships/opponent-status HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "POST /place-ship HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "GET /place-ships/opponent-status HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "POST /place-ship HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "GET /place-ships/opponent-status HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "POST /ready-for-game HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "GET /place-ships/opponent-status HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "POST /ready-for-game HTTP/1.1" 303 See Other
INFO:     127.0.0.1:34524 - "GET /game/7zf_5qWNV6wUO_IdjYANvA HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "GET /game/7zf_5qWNV6wUO_IdjYANvA/aiming-interface HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "GET /place-ships/opponent-status/long-poll?version=1 HTTP/1.1" 204 No Content
INFO:     127.0.0.1:34534 - "GET /game/7zf_5qWNV6wUO_IdjYANvA HTTP/1.1" 200 OK
INFO:     127.0.0.1:34534 - "GET /game/7zf_5qWNV6wUO_IdjYANvA/aiming-interface HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "POST /game/7zf_5qWNV6wUO_IdjYANvA/aim-shot HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "POST /game/7zf_5qWNV6wUO_IdjYANvA/aim-shot HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "POST /game/7zf_5qWNV6wUO_IdjYANvA/aim-shot HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "POST /game/7zf_5qWNV6wUO_IdjYANvA/aim-shot HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "POST /game/7zf_5qWNV6wUO_IdjYANvA/aim-shot HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "POST /game/7zf_5qWNV6wUO_IdjYANvA/aim-shot HTTP/1.1" 200 OK
INFO:     127.0.0.1:34524 - "POST /game/7zf_5qWNV6wUO_IdjYANvA/fire-shots HTTP/1.1" 200 OK
Lobby reset successful: {'status': 'lobby cleared'}
DEBUG opponent_fires_their_shots: Called
DEBUG opponent_fires_their_shots: Counter text: '0 / 6 available'
DEBUG opponent_fires_their_shots: current_shots=0, total_available=6
DEBUG opponent_fires_their_shots: Fire button visible=True, enabled=True
DEBUG opponent_fires_their_shots: Clicking fire button
DEBUG opponent_fires_their_shots: Fired shots
FAILEDINFO:     127.0.0.1:58106 - "POST /test/reset-lobby HTTP/1.1" 200 OK


=================================== FAILURES ===================================
___________________ test_long_polling_connection_resilience ____________________

fixturefunc = <function should_see_round_results_within_seconds at 0x7cf680e67380>
request = <FixtureRequest for <Function test_long_polling_connection_resilience>>
kwargs = {'page': <Page url='http://localhost:8000/game/7zf_5qWNV6wUO_IdjYANvA'>, 'seconds': 5}

    def call_fixture_func(
        fixturefunc: _FixtureFunc[FixtureValue], request: FixtureRequest, kwargs
    ) -> FixtureValue:
        if inspect.isgeneratorfunction(fixturefunc):
            fixturefunc = cast(Callable[..., Generator[FixtureValue]], fixturefunc)
            generator = fixturefunc(**kwargs)
            try:
                fixture_result = next(generator)
            except StopIteration:
                raise ValueError(f"{request.fixturename} did not yield a value") from None
            finalizer = functools.partial(_teardown_yield_fixture, fixturefunc, generator)
            request.addfinalizer(finalizer)
        else:
            fixturefunc = cast(Callable[..., FixtureValue], fixturefunc)
>           fixture_result = fixturefunc(**kwargs)
                             ^^^^^^^^^^^^^^^^^^^^^

.venv/lib/python3.13/site-packages/_pytest/fixtures.py:930: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

page = <Page url='http://localhost:8000/game/7zf_5qWNV6wUO_IdjYANvA'>
seconds = 5

    @then(parsers.parse("I should see the round results within {seconds:d} seconds"))
    def should_see_round_results_within_seconds(page: Page, seconds: int) -> None:
        """Verify round results are displayed within specified seconds"""
        timeout_ms = seconds * 1000
>       expect(page.locator('[data-testid="round-results"]')).to_be_visible(
            timeout=timeout_ms
        )
E       AssertionError: Locator expected to be visible
E       Actual value: <element(s) not found> 
E       Call log:
E         - Expect "to_be_visible" with timeout 5000ms
E         - waiting for locator("[data-testid=\"round-results\"]")

tests/bdd/test_gameplay_steps_browser.py:1837: AssertionError
=========================== short test summary info ============================
FAILED tests/bdd/test_gameplay_steps_browser.py::test_long_polling_connection_resilience
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
============================== 1 failed in 41.86s ==============================
