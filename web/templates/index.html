{% extends "base.html" %}

{% block content %}
<div id="app" class="game-container">
    {% if not game %}
        <!-- New Game Form -->
        <div id="new-game-form" class="card">
            <h2>Start New Game</h2>
            <form hx-post="/game/new" hx-target="#app" hx-swap="innerHTML">
                <div class="form-group">
                    <label for="player1_name">Your Name:</label>
                    <input type="text" id="player1_name" name="player1_name" value="Player" required>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="radio" name="vs_computer" value="true" checked>
                        Play against Computer
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="radio" name="vs_computer" value="false">
                        Play against Human
                    </label>
                </div>
                
                <div class="form-group" id="player2-name" style="display: none;">
                    <label for="player2_name">Opponent Name:</label>
                    <input type="text" id="player2_name" name="player2_name" value="Opponent">
                </div>
                
                <button type="submit" class="btn btn-primary">Start Game</button>
            </form>
        </div>
    {% else %}
        <!-- Game Interface -->
        <div id="game-interface">
            <!-- Game Status -->
            <div id="game-status" 
                 hx-get="/game/status" 
                 hx-trigger="load, every 2s"
                 hx-swap="innerHTML">
            </div>
            
            {% if game.phase.value == "setup" %}
                <!-- Ship Placement Phase -->
                <div id="setup-phase" class="phase-container">
                    <h2>Ship Placement</h2>
                    
                    <div class="game-boards">
                        <!-- Current Board -->
                        <div class="board-section">
                            <h3>Your Ships</h3>
                            <div id="player-board" 
                                 hx-get="/game/board/{{ game.player1.name }}"
                                 hx-trigger="load, shipPlaced from:body, every 2s"
                                 hx-swap="innerHTML">
                            </div>
                        </div>
                        
                        <!-- Ship Placement Controls -->
                        <div class="controls-section">
                            <div id="ship-placement-form"
                                 hx-get="/game/ship-placement"
                                 hx-trigger="load, shipPlaced from:body"
                                 hx-swap="innerHTML">
                            </div>
                            
                            <button id="auto-place-btn"
                                    hx-post="/game/auto-place-ships"
                                    hx-trigger="click"
                                    hx-swap="none"
                                    class="btn btn-secondary">
                                Auto-Place All Ships
                            </button>
                        </div>
                    </div>
                </div>
                
            {% elif game.phase.value == "playing" %}
                <!-- Playing Phase -->
                <div id="playing-phase" class="phase-container">
                    <h2>Battle Phase - Round {{ game.current_round }}</h2>
                    
                    <div class="game-boards">
                        <!-- Player's Ships Board -->
                        <div class="board-section">
                            <h3>Your Ships & Hits Received</h3>
                            <div id="player-ships-board"
                                 hx-get="/game/board/{{ game.player1.name }}"
                                 hx-trigger="load, shotsSubmitted from:body"
                                 hx-swap="innerHTML">
                            </div>
                        </div>
                        
                        <!-- Shots Fired Board -->
                        <div class="board-section">
                            <h3>Your Shots Fired</h3>
                            <div id="shots-fired-board"
                                 hx-get="/game/shots-fired/{{ game.player1.name }}"
                                 hx-trigger="load, shotsSubmitted from:body, every 3s"
                                 hx-swap="innerHTML">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Game Info Panels: Fleet Status & Hits Made -->
                    <div class="game-info-panels">
                        <!-- Fleet Status -->
                        <div>
                            <h3>Your Fleet Status</h3>
                            <div id="fleet-status"
                                 hx-get="/game/fleet-status/{{ game.player1.name }}"
                                 hx-trigger="load, shotsSubmitted from:body"
                                 hx-swap="innerHTML">
                            </div>
                        </div>
                        
                        <!-- Hits Made on Opponent -->
                        <div>
                            <h3>Hits Made on Opponent</h3>
                            <div id="hits-made"
                                 hx-get="/game/hits-made/{{ game.player1.name }}"
                                 hx-trigger="load, shotsSubmitted from:body, every 3s"
                                 hx-swap="innerHTML">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Shot Controls -->
                    <div class="controls-section">
                        <div id="shot-controls-container" 
                             hx-get="/game/shot-controls"
                             hx-trigger="load, shotsSubmitted from:body"
                             hx-swap="innerHTML">
                        </div>
                    </div>
                    
                    <!-- Round Results -->
                    <div id="round-results"
                         hx-get="/game/round-results"
                         hx-trigger="shotsSubmitted from:body"
                         hx-swap="innerHTML">
                    </div>
                </div>
                
            {% elif game.phase.value == "finished" %}
                <!-- Game Over -->
                <div id="finished-phase" class="phase-container">
                    <h2>Game Over</h2>
                    
                    {% if game.winner %}
                        <div class="winner-announcement">
                            <h3>üéâ {{ game.winner.name }} Wins! üéâ</h3>
                        </div>
                    {% else %}
                        <div class="draw-announcement">
                            <h3>ü§ù Game Ended in a Draw! ü§ù</h3>
                        </div>
                    {% endif %}
                    
                    <!-- Final Boards -->
                    <div class="game-boards">
                        <div class="board-section">
                            <h3>{{ game.player1.name }}'s Final State</h3>
                            <div hx-get="/game/board/{{ game.player1.name }}"
                                 hx-trigger="load"
                                 hx-swap="innerHTML">
                            </div>
                        </div>
                        
                        <div class="board-section">
                            <h3>{{ game.player2.name }}'s Final State</h3>
                            <div hx-get="/game/board/{{ game.player2.name }}"
                                 hx-trigger="load"
                                 hx-swap="innerHTML">
                            </div>
                        </div>
                    </div>
                    
                    <button hx-delete="/game"
                            hx-target="#app"
                            hx-swap="innerHTML"
                            hx-get="/"
                            class="btn btn-primary">
                        Start New Game
                    </button>
                </div>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
// Toggle player 2 name input based on vs_computer selection
document.addEventListener('change', function(e) {
    if (e.target.name === 'vs_computer') {
        const player2Div = document.getElementById('player2-name');
        if (e.target.value === 'false') {
            player2Div.style.display = 'block';
        } else {
            player2Div.style.display = 'none';
        }
    }
});

// Handle successful game creation
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.xhr.status === 200 && evt.detail.target.id === 'app') {
        // Reload the page to show the game interface
        window.location.reload();
    }
});
</script>
{% endblock %}